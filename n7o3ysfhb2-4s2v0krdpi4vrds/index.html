<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>The City at Night â€” Valentine</title>

  <!-- Google tag -->

<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
* {
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

body {
  margin: 0;
  background: #0b0e14;
  color: #eaeaea;
  overflow: hidden;
}

/* ===== SCENE ===== */
.scene {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  background-size: cover;
  background-position: center;
  transition: opacity 1.2s ease, transform 1.6s ease;
  transform: scale(1.03);
}

.scene.active {
  opacity: 1;
  pointer-events: auto;
  transform: scale(1);
}

.scene::before {
  content: "";
  position: absolute;
  inset: 0;
  background: radial-gradient(
    ellipse at center,
    rgba(0,0,0,0.15) 0%,
    rgba(0,0,0,0.55) 70%,
    rgba(0,0,0,0.85) 100%
  );
  z-index: 0;
}

/* ===== OVERLAY ===== */
.overlay {
  position: relative;
  z-index: 1;
  max-width: 520px;
  padding: 36px;
  border-radius: 18px;
  background: linear-gradient(
    to top,
    rgba(0,0,0,0.65),
    rgba(0,0,0,0.15),
    rgba(0,0,0,0)
  );
}

/* ===== TEXT + TYPEWRITER ===== */
.text {
  position: relative;
  font-size: 1.3rem;
  line-height: 1.6;
  min-height: 120px;
}

.line {
  opacity: 1;
  white-space: pre-wrap;
}

.cursor {
  display: inline-block;
  width: 2px;
  height: 1.1em;
  background: rgba(255,255,255,0.65);
  margin-left: 4px;
  animation: cursorBlink 1.4s ease-in-out infinite;
}

.cursor.hidden {
  opacity: 0;
  animation: none;
}

@keyframes cursorBlink {
  0%, 100% { opacity: 0.15; }
  50% { opacity: 0.65; }
}

/* ===== BUTTONS (SOFT, INTIMATE) ===== */
.buttons {
  display: flex;
  gap: 14px;
  flex-wrap: wrap;
  margin-top: 18px;
  opacity: 0;
  transition: opacity 1.2s ease;
}

.buttons.show {
  opacity: 1;
}

button {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.22);
  color: rgba(255,255,255,0.95);
  padding: 12px 22px;
  border-radius: 999px;
  font-size: 0.95rem;
  cursor: pointer;
  backdrop-filter: blur(10px);
  transition:
    background 0.4s ease,
    border-color 0.4s ease,
    box-shadow 0.4s ease,
    transform 0.4s ease;
}

button:hover {
  background: rgba(255,255,255,0.12);
  border-color: rgba(255,255,255,0.38);
  transform: scale(1.02);
}

/* Emotional differentiation for two-choice scenes */
button.primary {
  box-shadow: inset 0 0 0 1px rgba(255,220,180,0.15);
}

button.secondary {
  opacity: 0.85;
}

/* ===== ENDING OVERLAY (ROMANTIC) ===== */
body.ended::after {
  content: "This moment is yours.";
  position: fixed;
  inset: 0;
  background:
    radial-gradient(
      circle at center,
      rgba(255,220,180,0.08) 0%,
      rgba(11,14,20,0.65) 45%,
      rgba(11,14,20,0.92) 100%
    );
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.8rem;
  letter-spacing: 0.05em;
  color: rgba(255,255,255,0.92);
  text-shadow:
    0 2px 10px rgba(0,0,0,0.6),
    0 0 30px rgba(255,200,150,0.15);
  z-index: 9999;
  animation: fadeIn 3s ease forwards;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Resume hint */
.resume-hint {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 0.85rem;
  opacity: 0.6;
  pointer-events: none;
  transition: opacity 1s ease;
  z-index: 9999;
}

/* Dim scene while paused */
body.paused .scene.active::before {
  background: radial-gradient(
    ellipse at center,
    rgba(0,0,0,0.35) 0%,
    rgba(0,0,0,0.75) 70%,
    rgba(0,0,0,0.92) 100%
  );
}

body.paused .overlay {
  filter: blur(1px);
  opacity: 0.85;
  transition: filter 0.6s ease, opacity 0.6s ease;
}

@media (prefers-reduced-motion: reduce) {
  .scene { transition: opacity 0.4s ease; transform: none; }
  .cursor { animation: none; opacity: 0.65; }
  .buttons { transition: opacity 0.4s ease; }
}

/* Hide audio element */
audio {
  display: none;
}

.buttons {
  pointer-events: none;
}

.buttons.show {
  pointer-events: auto;
}

/* ===== FINAL VALENTINE OVERLAY ===== */
.final-overlay {
  position: fixed;
  inset: 0;
  background: rgba(11,14,20,0.82);
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 3s ease;
}

.final-overlay.show {
  opacity: 1;
  pointer-events: auto;
}

.final-message {
  font-size: 1.9rem;
  letter-spacing: 0.06em;
  color: rgba(255,230,200,0.95);
  text-align: center;
  text-shadow:
    0 2px 12px rgba(0,0,0,0.6),
    0 0 40px rgba(255,200,150,0.18);
  animation: finalFadeUp 3.5s ease forwards;
}

@keyframes finalFadeUp {
  from {
    opacity: 0;
    transform: translateY(12px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>
</head>

<body>

<!-- Background music -->
<audio id="bgMusic" loop preload="auto">
    <source src="music/romantic-ambient.mp3" type="audio/mpeg">
</audio>

<!-- SCENE 1 (active by default) -->
<div class="scene active" id="s1" style="background-image:url('images/1-entry.jpg')">
  <div class="overlay">
    <div class="text" data-lines>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="cursor"></div>
    </div>
    <div class="buttons">
      <button onclick="startMusicAndNext('s2')">Stay with me</button>
    </div>
  </div>
</div>

<!-- SCENE 2 -->
<div class="scene" id="s2" style="background-image:url('images/2-street.jpg')">
  <div class="overlay">
    <div class="text" data-lines>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="cursor"></div>
    </div>
    <div class="buttons">
      <button class="primary" onclick="next('s3a')">I like quiet</button>
      <button class="secondary" onclick="next('s3b')">I'm tired of noise</button>
    </div>
  </div>
</div>

<!-- SCENE 3A -->
<div class="scene" id="s3a" style="background-image:url('images/3-window.jpg')">
  <div class="overlay">
    <div class="text" data-lines>
      <div class="line"></div>
      <div class="line"></div>
      <div class="cursor"></div>
    </div>
    <div class="buttons">
      <button onclick="next('s4')">Look at the city</button>
    </div>
  </div>
</div>

<!-- SCENE 3B -->
<div class="scene" id="s3b" style="background-image:url('images/3-window.jpg')">
  <div class="overlay">
    <div class="text" data-lines>
      <div class="line"></div>
      <div class="line"></div>
      <div class="cursor"></div>
    </div>
    <div class="buttons">
      <button onclick="next('s4')">Look at the city</button>
    </div>
  </div>
</div>

<!-- SCENE 4 -->
<div class="scene" id="s4" style="background-image:url('images/4-lights.jpg')">
  <div class="overlay">
    <div class="text" data-lines>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="cursor"></div>
    </div>
    <div class="buttons">
      <button class="primary" onclick="next('s5')">That feels right</button>
      <button class="secondary" onclick="next('s5')">That feels intimate</button>
    </div>
  </div>
</div>

<!-- SCENE 5 -->
<div class="scene" id="s5" style="background-image:url('images/5-room.jpg')">
  <div class="overlay">
    <div class="text" data-lines>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="cursor"></div>
    </div>
    <div class="buttons">
      <button class="primary" onclick="next('s6')">I'm here</button>
      <button class="secondary" onclick="next('s6')">I didn't expect this</button>
    </div>
  </div>
</div>

<!-- SCENE 6 -->
<div class="scene" id="s6" style="background-image:url('images/6-balcony.jpg')">
  <div class="overlay">
    <div class="text" data-lines>
      <div class="line"></div>
      <div class="line"></div>
      <div class="cursor"></div>
    </div>
    <div class="buttons">
      <button onclick="next('s7')">Stay</button>
    </div>
  </div>
</div>

<!-- SCENE 7 -->
<div class="scene" id="s7" style="
  background-image:url('images/7-skyline.jpg');
  justify-content:flex-start;
  padding-left:8vw;">
  <div class="overlay">
    <div class="text" data-lines>
      <div class="line"></div>
      <div class="cursor"></div>
    </div>
    <div class="buttons">
      <button class="primary" onclick="next('s8')">Yes</button>
      <button class="secondary" onclick="next('s8')">Just hold this moment</button>
    </div>
  </div>
</div>

<!-- SCENE 8 -->
<div class="scene" id="s8" style="
  background-image:url('images/8-couple.jpg');
  background-position:center right;">
  <div class="overlay">
    <div class="text" data-lines>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="cursor"></div>
    </div>
    <div class="buttons">
      <button onclick="next('s9')">Continue</button>
    </div>
  </div>
</div>

<!-- SCENE 9 -->
<div class="scene" id="s9" style="background-image:url('images/9-heart.jpg')">
  <div class="overlay">
    <div class="text" data-lines>
      <div class="line"></div>
      <div class="line"></div>
      <div class="cursor"></div>
    </div>
    <div class="buttons">
      <button onclick="next('s10')">Stay a little longer</button>
    </div>
  </div>
</div>

<!-- SCENE 10 -->
<div class="scene" id="s10" style="background-image:url('images/10-dawn.jpg')">
  <div class="overlay">
    <div class="text" data-lines>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="cursor"></div>
    </div>
    <div class="buttons">
      <button onclick="showFinalValentine()">Create your Valentine</button>
    </div>
  </div>
</div>

<!-- FINAL VALENTINE OVERLAY -->
<div id="finalOverlay" class="final-overlay">
  <div class="final-message">
    This Valentine is yours.
  </div>
</div>

<script>
const sceneText = {
  s1: [
    "It's Valentine's night.",
    "The city looks the sameâ€¦",
    "But it feels different."
  ],
  s2: [
    "Most people celebrate loudly tonight.",
    "Reservations. Noise. Crowds.",
    "But some momentsâ€¦",
    "are meant to be quiet."
  ],
  s3a: ["Me too.", "Quiet lets you feel things properly."],
  s3b: ["Yeahâ€¦", "Love doesn't need an audience."],
  s4: [
    "Every light is someone loving someone.",
    "In their own way.",
    "Some loud.",
    "Some soft.",
    "Ours is soft."
  ],
  s5: [
    "Valentine's usually asks for big words.",
    "Big gestures.",
    "But tonightâ€¦",
    "I just wanted you here."
  ],
  s6: ["You stayingâ€¦", "means more than you think."],
  s7: ["Can I make this night ours?"],
  s8: [
    "So let's do this quietly.",
    "No promises shouted.",
    "Just you.",
    "And me.",
    "And the city."
  ],
  s9: ["Happy Valentine's.", "Thank you for choosing to be here."],
  s10: [
    "The night will pass.",
    "The city will wake.",
    "But thisâ€¦",
    "this stays."
  ]
};

/* ========================================
   STATE & INITIALIZATION
   ======================================== */

let typingTimeout;
let currentSceneId = 's1';

let typingState = {
  sceneId: 's1',
  lineIndex: 0,
  charIndex: 0,
  active: false
};

const bgMusic = document.getElementById('bgMusic');
const finalOverlay = document.getElementById('finalOverlay');

// Initialize
bgMusic.volume = 0;

/* ========================================
   AUDIO STATE MACHINE
   ======================================== */

const audioState = {
  unlocked: false,        // Has user clicked?
  isPlaying: false,       // Is audio currently playing?
  shouldBePlaying: false, // Should audio be playing when visible?
  targetVolume: 0.25,     // Normal playback volume
  fadeFrame: null,        // RequestAnimationFrame ID for fade

  // Logging helper
  log() {
    console.log('[STATE]', JSON.stringify({
      unlocked: this.unlocked,
      isPlaying: this.isPlaying,
      shouldBePlaying: this.shouldBePlaying,
      currentVolume: bgMusic.volume.toFixed(3),
      paused: bgMusic.paused,
      currentTime: bgMusic.currentTime.toFixed(2)
    }, null, 2));
  }
};

/* ========================================
   LOGGING UTILITIES
   ======================================== */

function logAudio(message, data = {}) {
  console.log(`[AUDIO] ${message}`, data);
  audioState.log();
}

function logVisibility(message, data = {}) {
  console.log(`[VISIBILITY] ${message}`, data);
  audioState.log();
}

function logError(message, error) {
  console.error(`[ERROR] ${message}`, error);
  audioState.log();
}

/* ========================================
   AUDIO UNLOCK (First User Interaction)
   ======================================== */

function unlockAudio() {
  if (audioState.unlocked) {
    logAudio('Already unlocked, skipping');
    return;
  }

  logAudio('Attempting audio unlock...');

  // Only try AudioContext if it might help
  // Samsung Chrome sometimes needs this, but it can also cause issues
  try {
    const AudioContextClass = window.AudioContext || window.webkitAudioContext;
    if (AudioContextClass) {
      const ctx = new AudioContextClass();
      logAudio('AudioContext created', { state: ctx.state });

      if (ctx.state === 'suspended') {
        ctx.resume().then(() => {
          logAudio('AudioContext resumed successfully');
        }).catch(err => {
          logError('AudioContext resume failed', err);
        });
      }

      // Clean up immediately to avoid conflicts
      setTimeout(() => ctx.close(), 100);
    }
  } catch (e) {
    logError('AudioContext creation failed (non-critical)', e);
  }

  audioState.unlocked = true;
  logAudio('Audio unlocked successfully');
}

// Listen for first interaction
['click', 'touchstart', 'touchend'].forEach(evt => {
  document.addEventListener(evt, unlockAudio, { once: true, passive: true });
});

/* ========================================
   FADE SYSTEM
   ======================================== */

function stopFade() {
  if (audioState.fadeFrame) {
    cancelAnimationFrame(audioState.fadeFrame);
    audioState.fadeFrame = null;
    logAudio('Fade cancelled');
  }
}

function fadeTo(targetVolume, durationMs, onComplete = null) {
  stopFade();

  const startVolume = bgMusic.volume;
  const startTime = performance.now();

  logAudio(`Fade started: ${startVolume.toFixed(3)} â†’ ${targetVolume.toFixed(3)}`, {
    duration: durationMs
  });

  function animate(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / durationMs, 1);

    // Ease-out cubic
    const eased = 1 - Math.pow(1 - progress, 3);
    bgMusic.volume = startVolume + (targetVolume - startVolume) * eased;

    if (progress < 1) {
      audioState.fadeFrame = requestAnimationFrame(animate);
    } else {
      audioState.fadeFrame = null;
      logAudio(`Fade completed: ${bgMusic.volume.toFixed(3)}`);
      if (onComplete) onComplete();
    }
  }

  audioState.fadeFrame = requestAnimationFrame(animate);
}

/* ========================================
   CORE AUDIO CONTROLS
   ======================================== */

/**
 * Start music playback
 * CRITICAL: Must be called DIRECTLY in user gesture handler
 */
function startMusic() {
  logAudio('startMusic() called', {
    unlocked: audioState.unlocked,
    isPlaying: audioState.isPlaying,
    paused: bgMusic.paused
  });

  if (!audioState.unlocked) {
    logError('Audio not unlocked - cannot start');
    return;
  }

  if (audioState.isPlaying) {
    logAudio('Already playing - ignoring');
    return;
  }

  // CRITICAL: Call play() synchronously (no await, no setTimeout)
  logAudio('Calling bgMusic.play() synchronously...');

  const playPromise = bgMusic.play();

  if (playPromise !== undefined) {
    playPromise
      .then(() => {
        audioState.isPlaying = true;
        audioState.shouldBePlaying = true;

        logAudio('play() succeeded! Starting fade-in', {
          currentTime: bgMusic.currentTime,
          volume: bgMusic.volume
        });

        // Fade in to target volume
        fadeTo(audioState.targetVolume, 3000);
      })
      .catch(error => {
        audioState.isPlaying = false;
        audioState.shouldBePlaying = false;

        logError('play() FAILED - This is the root cause', {
          error: error.message,
          errorName: error.name,
          paused: bgMusic.paused,
          readyState: bgMusic.readyState,
          networkState: bgMusic.networkState
        });

        // Suggest fix to user
        console.warn('ðŸ’¡ TIP: Check if audio file exists at: music/romantic-ambient.mp3');
      });
  } else {
    logError('play() returned undefined (very old browser)');
  }
}

/**
 * Stop music with optional fade
 */
function stopMusic(immediate = false) {
  logAudio('stopMusic() called', { immediate });

  audioState.shouldBePlaying = false;

  if (immediate) {
    stopFade();
    bgMusic.pause();
    bgMusic.volume = 0;
    audioState.isPlaying = false;
    logAudio('Music stopped immediately');
  } else {
    fadeTo(0, 2000, () => {
      bgMusic.pause();
      audioState.isPlaying = false;
      logAudio('Music stopped after fade-out');
    });
  }
}

/**
 * Pause immediately (for backgrounding)
 */
function pauseMusic() {
  logAudio('pauseMusic() called');

  stopFade();
  bgMusic.pause();
  audioState.isPlaying = false;

  logAudio('Music paused immediately', {
    shouldBePlaying: audioState.shouldBePlaying
  });
}

/**
 * Resume playback (must be from user gesture on mobile)
 */
function resumeMusic() {
  logAudio('resumeMusic() called', {
    shouldBePlaying: audioState.shouldBePlaying,
    isPlaying: audioState.isPlaying
  });

  if (!audioState.shouldBePlaying) {
    logAudio('shouldBePlaying = false, not resuming');
    return;
  }

  if (audioState.isPlaying) {
    logAudio('Already playing, not resuming');
    return;
  }

  logAudio('Attempting resume via play()...');

  const playPromise = bgMusic.play();

  if (playPromise !== undefined) {
    playPromise
      .then(() => {
        audioState.isPlaying = true;
        logAudio('Resume succeeded! Fading in...');
        fadeTo(audioState.targetVolume, 2000);
      })
      .catch(error => {
        logError('Resume failed', {
          error: error.message,
          errorName: error.name
        });
      });
  }
}

/**
 * Complete reset (for ending)
 */
function resetAudio() {
  logAudio('resetAudio() called - full reset');

  stopFade();
  bgMusic.pause();
  bgMusic.currentTime = 0;
  bgMusic.volume = 0;

  audioState.isPlaying = false;
  audioState.shouldBePlaying = false;

  logAudio('Audio fully reset');
}

/* ========================================
   VISIBILITY HANDLING
   ======================================== */

let waitingForResume = false;

document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    // === PAGE HIDDEN (backgrounded) ===

    logVisibility('Page hidden (backgrounded)', {
      isPlaying: audioState.isPlaying,
      shouldBePlaying: audioState.shouldBePlaying
    });

    // Stop typing
    typingState.active = false;
    clearTimeout(typingTimeout);

    // Pause music IMMEDIATELY
    if (audioState.isPlaying) {
      pauseMusic();
      logVisibility('Music paused due to backgrounding');
    }

    document.body.classList.add('paused');

  } else {
    // === PAGE VISIBLE (foregrounded) ===

    logVisibility('Page visible (foregrounded)', {
      shouldBePlaying: audioState.shouldBePlaying,
      isPlaying: audioState.isPlaying,
      typingLineIndex: typingState.lineIndex
    });

    // If we should be playing or typing has started, wait for user tap
    if (audioState.shouldBePlaying || typingState.lineIndex > 0) {
      waitingForResume = true;
      showResumeHint();
      logVisibility('Waiting for user tap to resume');
    }
  }
});

/* ========================================
   RESUME HANDLING
   ======================================== */

function showResumeHint() {
  const oldHint = document.querySelector('.resume-hint');
  if (oldHint) oldHint.remove();

  const hint = document.createElement('div');
  hint.className = 'resume-hint';
  hint.textContent = "Tap anywhere to continue";
  document.body.appendChild(hint);

  setTimeout(() => hint.remove(), 5000);

  logVisibility('Resume hint shown');
}

// Handle tap to resume
document.addEventListener('click', (e) => {
  if (e.target.tagName === 'BUTTON') return;

  if (waitingForResume) {
    logVisibility('User tapped to resume');

    waitingForResume = false;
    document.body.classList.remove('paused');

    // Remove hint
    const hint = document.querySelector('.resume-hint');
    if (hint) hint.remove();

    // Resume typing
    const scene = document.getElementById(typingState.sceneId);
    typeLines(
      sceneText[typingState.sceneId],
      scene.querySelector('.text'),
      () => scene.querySelector('.buttons').classList.add('show'),
      true
    );

    // Resume music if needed
    if (audioState.shouldBePlaying && !audioState.isPlaying) {
      logVisibility('Attempting to resume music from user tap');
      resumeMusic();
    }
  }
});

// Prevent button clicks when paused or buttons not ready
document.addEventListener('click', (e) => {
  if (e.target.tagName === 'BUTTON') {
    if (waitingForResume) {
      e.preventDefault();
      e.stopPropagation();
      logVisibility('Button click blocked - waiting for resume');
      return false;
    }

    const buttonsContainer = e.target.closest('.buttons');
    if (!buttonsContainer || !buttonsContainer.classList.contains('show')) {
      e.preventDefault();
      e.stopPropagation();
      logVisibility('Button click blocked - buttons not ready');
      return false;
    }
  }
}, true);

/* ========================================
   CLEANUP ON PAGE CLOSE
   ======================================== */

window.addEventListener('pagehide', () => {
  logVisibility('Page closing (pagehide)');
  stopMusic(true);
});

window.addEventListener('beforeunload', () => {
  logVisibility('Page closing (beforeunload)');
  stopMusic(true);
});

/* ========================================
   DEBUG: Log audio events
   ======================================== */

bgMusic.addEventListener('loadstart', () => logAudio('Event: loadstart'));
bgMusic.addEventListener('loadeddata', () => logAudio('Event: loadeddata'));
bgMusic.addEventListener('canplay', () => logAudio('Event: canplay'));
bgMusic.addEventListener('canplaythrough', () => logAudio('Event: canplaythrough'));
bgMusic.addEventListener('play', () => logAudio('Event: play'));
bgMusic.addEventListener('pause', () => logAudio('Event: pause'));
bgMusic.addEventListener('ended', () => logAudio('Event: ended'));
bgMusic.addEventListener('error', (e) => {
  logError('Audio element error event', {
    error: e.error,
    code: e.error?.code,
    message: e.error?.message,
    src: bgMusic.currentSrc
  });
});

// Log initial state
console.log('='.repeat(50));
console.log('AUDIO SYSTEM INITIALIZED');
console.log('='.repeat(50));
audioState.log();
console.log('Audio element:', bgMusic);
console.log('Audio source:', bgMusic.currentSrc || bgMusic.src);
console.log('='.repeat(50));

/* ========================================
   TYPEWRITER SYSTEM
   ======================================== */

function typeLines(lines, container, callback, resume = false) {
  const lineEls = container.querySelectorAll('.line');
  const cursor = container.querySelector('.cursor');

  if (!resume) {
    lineEls.forEach(l => l.textContent = "");
    typingState.lineIndex = 0;
    typingState.charIndex = 0;
  }

  typingState.active = true;
  cursor.classList.remove('hidden');

  function step() {
    if (!typingState.active) return;

    const { lineIndex, charIndex } = typingState;
    if (lineIndex >= lines.length) {
      cursor.classList.add('hidden');
      typingState.active = false;
      callback && callback();
      return;
    }

    const line = lines[lineIndex];
    const el = lineEls[lineIndex];

    if (charIndex < line.length) {
      el.textContent += line[charIndex];
      typingState.charIndex++;

      let delay = 65 + Math.random() * 40;
      if (['.', 'â€¦', ','].includes(line[charIndex])) delay += 250;

      typingTimeout = setTimeout(step, delay);
    } else {
      typingState.lineIndex++;
      typingState.charIndex = 0;
      typingTimeout = setTimeout(step, 650);
    }
  }

  step();
}

/* ========================================
   SCENE NAVIGATION
   ======================================== */

function startMusicAndNext(id) {
  // Unlock audio if needed
  unlockAudio();

  // CRITICAL: Start music synchronously in click handler
  startMusic();

  // Then navigate
  next(id);
}

function next(id) {
  clearTimeout(typingTimeout);

  currentSceneId = id;
  typingState.sceneId = id;
  typingState.active = false;

  document.querySelectorAll('.scene').forEach(s => {
    s.classList.remove('active');
    s.querySelector('.buttons')?.classList.remove('show');
  });

  const scene = document.getElementById(id);
  scene.classList.add('active');

  typeLines(sceneText[id], scene.querySelector('.text'), () => {
    scene.querySelector('.buttons').classList.add('show');
  });
}

function showFinalValentine() {
  document.body.classList.add('paused');

  // Fade out music over 5 seconds
  fadeTo(0, 5000, () => {
    resetAudio();
  });

  // Show final overlay after 1.2s
  setTimeout(() => {
    finalOverlay.classList.add('show');
  }, 1200);
}

/* ========================================
   INITIALIZE
   ======================================== */

// Start first scene
const firstScene = document.getElementById('s1');
typeLines(sceneText.s1, firstScene.querySelector('.text'), () => {
  firstScene.querySelector('.buttons').classList.add('show');
});

</script>

</body>
</html>
