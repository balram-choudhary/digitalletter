<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>The City at Night — Valentine</title>

  <!-- Google tag -->

<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
* {
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

body {
  margin: 0;
  background: #0b0e14;
  color: #eaeaea;
  overflow: hidden;
}

/* ===== SCENE ===== */
.scene {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  background-size: cover;
  background-position: center;
  transition: opacity 1.2s ease, transform 1.6s ease;
  transform: scale(1.03);
}

.scene.active {
  opacity: 1;
  pointer-events: auto;
  transform: scale(1);
}

.scene::before {
  content: "";
  position: absolute;
  inset: 0;
  background: radial-gradient(
    ellipse at center,
    rgba(0,0,0,0.15) 0%,
    rgba(0,0,0,0.55) 70%,
    rgba(0,0,0,0.85) 100%
  );
  z-index: 0;
}

/* ===== OVERLAY ===== */
.overlay {
  position: relative;
  z-index: 1;
  max-width: 520px;
  padding: 36px;
  border-radius: 18px;
  background: linear-gradient(
    to top,
    rgba(0,0,0,0.65),
    rgba(0,0,0,0.15),
    rgba(0,0,0,0)
  );
}

/* ===== TEXT + TYPEWRITER ===== */
.text {
  position: relative;
  font-size: 1.3rem;
  line-height: 1.6;
  min-height: 120px;
}

.line {
  opacity: 1;
  white-space: pre-wrap;
}

.cursor {
  display: inline-block;
  width: 2px;
  height: 1.1em;
  background: rgba(255,255,255,0.65);
  margin-left: 4px;
  animation: cursorBlink 1.4s ease-in-out infinite;
}

.cursor.hidden {
  opacity: 0;
  animation: none;
}

@keyframes cursorBlink {
  0%, 100% { opacity: 0.15; }
  50% { opacity: 0.65; }
}

/* ===== BUTTONS (SOFT, INTIMATE) ===== */
.buttons {
  display: flex;
  gap: 14px;
  flex-wrap: wrap;
  margin-top: 18px;
  opacity: 0;
  transition: opacity 1.2s ease;
}

.buttons.show {
  opacity: 1;
}

button {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.22);
  color: rgba(255,255,255,0.95);
  padding: 12px 22px;
  border-radius: 999px;
  font-size: 0.95rem;
  cursor: pointer;
  backdrop-filter: blur(10px);
  transition:
    background 0.4s ease,
    border-color 0.4s ease,
    box-shadow 0.4s ease,
    transform 0.4s ease;
}

button:hover {
  background: rgba(255,255,255,0.12);
  border-color: rgba(255,255,255,0.38);
  transform: scale(1.02);
}

/* Emotional differentiation for two-choice scenes */
button.primary {
  box-shadow: inset 0 0 0 1px rgba(255,220,180,0.15);
}

button.secondary {
  opacity: 0.85;
}

/* ===== ENDING OVERLAY (ROMANTIC) ===== */
body.ended::after {
  content: "This moment is yours.";
  position: fixed;
  inset: 0;
  background:
    radial-gradient(
      circle at center,
      rgba(255,220,180,0.08) 0%,
      rgba(11,14,20,0.65) 45%,
      rgba(11,14,20,0.92) 100%
    );
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.8rem;
  letter-spacing: 0.05em;
  color: rgba(255,255,255,0.92);
  text-shadow:
    0 2px 10px rgba(0,0,0,0.6),
    0 0 30px rgba(255,200,150,0.15);
  z-index: 9999;
  animation: fadeIn 3s ease forwards;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Resume hint */
.resume-hint {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 0.85rem;
  opacity: 0.6;
  pointer-events: none;
  transition: opacity 1s ease;
  z-index: 9999;
}

/* Dim scene while paused */
body.paused .scene.active::before {
  background: radial-gradient(
    ellipse at center,
    rgba(0,0,0,0.35) 0%,
    rgba(0,0,0,0.75) 70%,
    rgba(0,0,0,0.92) 100%
  );
}

body.paused .overlay {
  filter: blur(1px);
  opacity: 0.85;
  transition: filter 0.6s ease, opacity 0.6s ease;
}

@media (prefers-reduced-motion: reduce) {
  .scene { transition: opacity 0.4s ease; transform: none; }
  .cursor { animation: none; opacity: 0.65; }
  .buttons { transition: opacity 0.4s ease; }
}

/* Hide audio element */
audio {
  display: none;
}

.buttons {
  pointer-events: none;
}

.buttons.show {
  pointer-events: auto;
}

/* ===== FINAL VALENTINE OVERLAY ===== */
.final-overlay {
  position: fixed;
  inset: 0;
  background: rgba(11,14,20,0.82);
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 3s ease;
}

.final-overlay.show {
  opacity: 1;
  pointer-events: auto;
}

.final-message {
  font-size: 1.9rem;
  letter-spacing: 0.06em;
  color: rgba(255,230,200,0.95);
  text-align: center;
  text-shadow:
    0 2px 12px rgba(0,0,0,0.6),
    0 0 40px rgba(255,200,150,0.18);
  animation: finalFadeUp 3.5s ease forwards;
}

@keyframes finalFadeUp {
  from {
    opacity: 0;
    transform: translateY(12px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>
</head>

<body>

<!-- Background music - Oppo-optimized -->
<audio id="bgMusic" loop preload="metadata">
    <source src="music/romantic-ambient.mp3" type="audio/mpeg">
</audio>

<!-- SCENE 1 (active by default) -->
<div class="scene active" id="s1" style="background-image:url('images/1-entry.jpg')">
  <div class="overlay">
    <div class="text" data-lines>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="cursor"></div>
    </div>
    <div class="buttons">
      <button onclick="startMusicAndNext('s2')">Stay with me</button>
    </div>
  </div>
</div>

<!-- SCENE 2 -->
<div class="scene" id="s2" style="background-image:url('images/2-street.jpg')">
  <div class="overlay">
    <div class="text" data-lines>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="cursor"></div>
    </div>
    <div class="buttons">
      <button class="primary" onclick="next('s3a')">I like quiet</button>
      <button class="secondary" onclick="next('s3b')">I'm tired of noise</button>
    </div>
  </div>
</div>

<!-- SCENE 3A -->
<div class="scene" id="s3a" style="background-image:url('images/3-window.jpg')">
  <div class="overlay">
    <div class="text" data-lines>
      <div class="line"></div>
      <div class="line"></div>
      <div class="cursor"></div>
    </div>
    <div class="buttons">
      <button onclick="next('s4')">Look at the city</button>
    </div>
  </div>
</div>

<!-- SCENE 3B -->
<div class="scene" id="s3b" style="background-image:url('images/3-window.jpg')">
  <div class="overlay">
    <div class="text" data-lines>
      <div class="line"></div>
      <div class="line"></div>
      <div class="cursor"></div>
    </div>
    <div class="buttons">
      <button onclick="next('s4')">Look at the city</button>
    </div>
  </div>
</div>

<!-- SCENE 4 -->
<div class="scene" id="s4" style="background-image:url('images/4-lights.jpg')">
  <div class="overlay">
    <div class="text" data-lines>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="cursor"></div>
    </div>
    <div class="buttons">
      <button class="primary" onclick="next('s5')">That feels right</button>
      <button class="secondary" onclick="next('s5')">That feels intimate</button>
    </div>
  </div>
</div>

<!-- SCENE 5 -->
<div class="scene" id="s5" style="background-image:url('images/5-room.jpg')">
  <div class="overlay">
    <div class="text" data-lines>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="cursor"></div>
    </div>
    <div class="buttons">
      <button class="primary" onclick="next('s6')">I'm here</button>
      <button class="secondary" onclick="next('s6')">I didn't expect this</button>
    </div>
  </div>
</div>

<!-- SCENE 6 -->
<div class="scene" id="s6" style="background-image:url('images/6-balcony.jpg')">
  <div class="overlay">
    <div class="text" data-lines>
      <div class="line"></div>
      <div class="line"></div>
      <div class="cursor"></div>
    </div>
    <div class="buttons">
      <button onclick="next('s7')">Stay</button>
    </div>
  </div>
</div>

<!-- SCENE 7 -->
<div class="scene" id="s7" style="
  background-image:url('images/7-skyline.jpg');
  justify-content:flex-start;
  padding-left:8vw;">
  <div class="overlay">
    <div class="text" data-lines>
      <div class="line"></div>
      <div class="cursor"></div>
    </div>
    <div class="buttons">
      <button class="primary" onclick="next('s8')">Yes</button>
      <button class="secondary" onclick="next('s8')">Just hold this moment</button>
    </div>
  </div>
</div>

<!-- SCENE 8 -->
<div class="scene" id="s8" style="
  background-image:url('images/8-couple.jpg');
  background-position:center right;">
  <div class="overlay">
    <div class="text" data-lines>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="cursor"></div>
    </div>
    <div class="buttons">
      <button onclick="next('s9')">Continue</button>
    </div>
  </div>
</div>

<!-- SCENE 9 -->
<div class="scene" id="s9" style="background-image:url('images/9-heart.jpg')">
  <div class="overlay">
    <div class="text" data-lines>
      <div class="line"></div>
      <div class="line"></div>
      <div class="cursor"></div>
    </div>
    <div class="buttons">
      <button onclick="next('s10')">Stay a little longer</button>
    </div>
  </div>
</div>

<!-- SCENE 10 -->
<div class="scene" id="s10" style="background-image:url('images/10-dawn.jpg')">
  <div class="overlay">
    <div class="text" data-lines>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="cursor"></div>
    </div>
    <div class="buttons">
      <button onclick="showFinalValentine()">Create your Valentine</button>
    </div>
  </div>
</div>

<!-- FINAL VALENTINE OVERLAY -->
<div id="finalOverlay" class="final-overlay">
  <div class="final-message">
    This Valentine is yours.
  </div>
</div>

<script>
const sceneText = {
  s1: [
    "It's Valentine's night.",
    "The city looks the same…",
    "But it feels different."
  ],
  s2: [
    "Most people celebrate loudly tonight.",
    "Reservations. Noise. Crowds.",
    "But some moments…",
    "are meant to be quiet."
  ],
  s3a: ["Me too.", "Quiet lets you feel things properly."],
  s3b: ["Yeah…", "Love doesn't need an audience."],
  s4: [
    "Every light is someone loving someone.",
    "In their own way.",
    "Some loud.",
    "Some soft.",
    "Ours is soft."
  ],
  s5: [
    "Valentine's usually asks for big words.",
    "Big gestures.",
    "But tonight…",
    "I just wanted you here."
  ],
  s6: ["You staying…", "means more than you think."],
  s7: ["Can I make this night ours?"],
  s8: [
    "So let's do this quietly.",
    "No promises shouted.",
    "Just you.",
    "And me.",
    "And the city."
  ],
  s9: ["Happy Valentine's.", "Thank you for choosing to be here."],
  s10: [
    "The night will pass.",
    "The city will wake.",
    "But this…",
    "this stays."
  ]
};

/* ========================================
   ULTRA-MINIMAL AUDIO SYSTEM (Oppo-safe)
   ======================================== */

let typingTimeout;
let currentSceneId = 's1';

let typingState = {
  sceneId: 's1',
  lineIndex: 0,
  charIndex: 0,
  active: false
};

const bgMusic = document.getElementById('bgMusic');
const finalOverlay = document.getElementById('finalOverlay');

// Minimal audio state
const audioState = {
  isPlaying: false,
  shouldBePlaying: false,
  targetVolume: 0.25,
  fadeFrame: null
};

// Initialize
bgMusic.volume = 0;

/**
 * Start music playback - Oppo-safe version
 * CRITICAL: Must be called DIRECTLY in click handler
 */
function startMusic() {
  console.log('[AUDIO] startMusic() called');

  if (!bgMusic.paused) {
    console.log('[AUDIO] Already playing');
    return;
  }

  // Oppo fix: Set tiny volume BEFORE play
  bgMusic.volume = 0.01;

  // CRITICAL: Call play() IMMEDIATELY, no async before this
  const playPromise = bgMusic.play();

  if (playPromise !== undefined) {
    playPromise
      .then(() => {
        console.log('[AUDIO] play() succeeded');
        audioState.isPlaying = true;
        audioState.shouldBePlaying = true;
        // Fade up AFTER play succeeds
        fadeTo(audioState.targetVolume, 2500);
      })
      .catch(err => {
        console.error('[AUDIO] play() failed:', err);
        audioState.isPlaying = false;
        audioState.shouldBePlaying = false;
      });
  }
}

/**
 * Fade volume to target
 */
function fadeTo(target, duration, callback = null) {
  if (audioState.fadeFrame) {
    cancelAnimationFrame(audioState.fadeFrame);
  }

  const start = performance.now();
  const startVol = bgMusic.volume;

  function step(now) {
    const elapsed = now - start;
    const progress = Math.min(elapsed / duration, 1);
    bgMusic.volume = startVol + (target - startVol) * progress;

    if (progress < 1) {
      audioState.fadeFrame = requestAnimationFrame(step);
    } else {
      audioState.fadeFrame = null;
      if (callback) callback();
    }
  }

  audioState.fadeFrame = requestAnimationFrame(step);
}

/**
 * Pause immediately (for backgrounding)
 */
function pauseMusic() {
  console.log('[AUDIO] pauseMusic()');
  if (audioState.fadeFrame) {
    cancelAnimationFrame(audioState.fadeFrame);
    audioState.fadeFrame = null;
  }
  bgMusic.pause();
  audioState.isPlaying = false;
}

/**
 * Reset audio (for final scene)
 */
function resetAudio() {
  if (audioState.fadeFrame) {
    cancelAnimationFrame(audioState.fadeFrame);
  }
  bgMusic.pause();
  bgMusic.currentTime = 0;
  bgMusic.volume = 0;
  audioState.isPlaying = false;
  audioState.shouldBePlaying = false;
}

/* ========================================
   VISIBILITY HANDLING (Simplified)
   ======================================== */

let waitingForResume = false;

document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    // Page hidden
    if (audioState.isPlaying) {
      pauseMusic();
      document.body.classList.add('paused');
    }
  } else {
    // Page visible
    if (audioState.shouldBePlaying) {
      waitingForResume = true;
      showResumeHint();
    }
  }
});

function showResumeHint() {
  const oldHint = document.querySelector('.resume-hint');
  if (oldHint) oldHint.remove();

  const hint = document.createElement('div');
  hint.className = 'resume-hint';
  hint.textContent = "Tap anywhere to continue";
  document.body.appendChild(hint);
  setTimeout(() => hint.remove(), 5000);
}

// Handle tap to resume
document.addEventListener('click', (e) => {
  if (e.target.tagName === 'BUTTON') return;

  if (waitingForResume) {
    waitingForResume = false;
    document.body.classList.remove('paused');
    const hint = document.querySelector('.resume-hint');
    if (hint) hint.remove();

    // Resume music if needed
    if (audioState.shouldBePlaying && !audioState.isPlaying) {
      startMusic();
    }
  }
});

// Cleanup on page close
window.addEventListener('pagehide', () => pauseMusic());
window.addEventListener('beforeunload', () => pauseMusic());

/* ========================================
   TYPEWRITER SYSTEM
   ======================================== */

function typeLines(lines, container, callback, resume = false) {
  const lineEls = container.querySelectorAll('.line');
  const cursor = container.querySelector('.cursor');

  if (!resume) {
    lineEls.forEach(l => l.textContent = "");
    typingState.lineIndex = 0;
    typingState.charIndex = 0;
  }

  typingState.active = true;
  cursor.classList.remove('hidden');

  function step() {
    if (!typingState.active) return;

    const { lineIndex, charIndex } = typingState;
    if (lineIndex >= lines.length) {
      cursor.classList.add('hidden');
      typingState.active = false;
      callback && callback();
      return;
    }

    const line = lines[lineIndex];
    const el = lineEls[lineIndex];

    if (charIndex < line.length) {
      el.textContent += line[charIndex];
      typingState.charIndex++;

      let delay = 65 + Math.random() * 40;
      if (['.', '…', ','].includes(line[charIndex])) delay += 250;

      typingTimeout = setTimeout(step, delay);
    } else {
      typingState.lineIndex++;
      typingState.charIndex = 0;
      typingTimeout = setTimeout(step, 650);
    }
  }

  step();
}

/* ========================================
   SCENE NAVIGATION
   ======================================== */

function startMusicAndNext(id) {
  // CRITICAL: Start music synchronously in click handler
  startMusic();
  // Then navigate
  next(id);
}

function next(id) {
  clearTimeout(typingTimeout);

  currentSceneId = id;
  typingState.sceneId = id;
  typingState.active = false;

  document.querySelectorAll('.scene').forEach(s => {
    s.classList.remove('active');
    s.querySelector('.buttons')?.classList.remove('show');
  });

  const scene = document.getElementById(id);
  scene.classList.add('active');

  typeLines(sceneText[id], scene.querySelector('.text'), () => {
    scene.querySelector('.buttons').classList.add('show');
  });
}

/* ===== BUTTON CLICK HANDLER ===== */
document.addEventListener('click', (e) => {
  if (e.target.tagName === 'BUTTON') {
    if (waitingForResume) {
      e.preventDefault();
      e.stopPropagation();
      return false;
    }

    const buttonsContainer = e.target.closest('.buttons');
    if (!buttonsContainer || !buttonsContainer.classList.contains('show')) {
      e.preventDefault();
      e.stopPropagation();
      return false;
    }
  }
}, true);

/* ===== FINAL VALENTINE MOMENT ===== */
function showFinalValentine() {
  document.body.classList.add('paused');

  // Fade out music over 5 seconds
  fadeTo(0, 5000, () => {
    resetAudio();
  });

  // Show final overlay after 1.2s
  setTimeout(() => {
    finalOverlay.classList.add('show');
  }, 1200);
}

/* ========================================
   INITIALIZE
   ======================================== */

// Start first scene
const firstScene = document.getElementById('s1');
typeLines(sceneText.s1, firstScene.querySelector('.text'), () => {
  firstScene.querySelector('.buttons').classList.add('show');
});

</script>

</body>
</html>
